<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Código Aprimorado</title>
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/dialog/dialog.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/matchesonscrollbar.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/show-hint.min.css">
    <style>
        :root {
            --primary-color: #4CAF50;
            --primary-hover: #45a049;
            --background-color: #f5f5f5;
            --border-color: #ddd;
            --text-color: #333;
            --toolbar-height: 60px;
            --header-height: 50px;
            --statusbar-height: 30px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background-color: #333;
            color: white;
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: var(--header-height);
            flex-shrink: 0;
        }

        .title {
            margin: 0;
            font-size: 1.1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .toolbar {
            background-color: #f8f8f8;
            border-bottom: 1px solid var(--border-color);
            padding: 8px 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            min-height: var(--toolbar-height);
            flex-shrink: 0;
            overflow-x: auto;
        }

        .toolbar-group {
            display: flex;
            gap: 5px;
            align-items: row;
            flex-shrink: 0;
        }

        .separator {
            height: 20px;
            width: 1px;
            background-color: var(--border-color);
            margin: 0 3px;
            flex-shrink: 0;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            min-height: 36px;
            touch-action: manipulation;
        }

        button:hover {
            background-color: var(--primary-hover);
        }

        button.icon-btn {
            background-color: transparent;
            color: var(--text-color);
            width: 36px;
            height: 36px;
            padding: 4px;
            min-width: 36px;
        }

        button.icon-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .search-container {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: wrap;
        }

        input[type="text"], select {
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            min-height: 36px;
            touch-action: manipulation;
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        select {
            padding: 7px 8px;
            min-width: 120px;
        }

        .editor-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* CodeMirror customizações */
        .CodeMirror {
            height: 100%;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            
        }

        .CodeMirror-matchingbracket {
            color: #0f0 !important;
            font-weight: bold;
        }

        .statusbar {
            background-color: #f0f0f0;
            border-top: 1px solid var(--border-color);
            padding: 4px 10px;
            font-size: 11px;
            color: #666;
            display: flex;
            justify-content: space-between;
            min-height: var(--statusbar-height);
            flex-shrink: 0;
            overflow: hidden;
        }

        .statusbar-left, .statusbar-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .snippet-container {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 10px;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
        }

        .snippet-item {
            padding: 5px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .snippet-item:hover {
            background-color: #f5f5f5;
        }

        .snippet-name {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .snippet-preview {
            font-size: 12px;
            color: #666;
            white-space: pre-wrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: 40px;
        }

        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 10px;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 6px;
            width: 500px;
            max-width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-title {
            font-size: 1.2rem;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            min-height: auto;
        }

        .settings-group {
            margin-bottom: 15px;
        }

        .settings-group h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .settings-row {
            display: flex;
            margin-bottom: 8px;
            align-items: center;
            gap: 10px;
        }

        .settings-label {
            flex: 1;
            min-width: 0;
        }

        .search-results {
            margin-left: 5px;
            font-size: 12px;
            white-space: nowrap;
        }

        .nav-buttons {
            display: flex;
            gap: 2px;
        }

        /* Responsivo para tablets */
        @media (max-width: 768px) {
            .title {
                font-size: 1rem;
            }
            
            .toolbar {
                padding: 6px 8px;
                gap: 6px;
            }
            
            .toolbar-group {
                flex-wrap: wrap;
            }
            
            select {
                min-width: 100px;
                font-size: 13px;
            }
            
            button {
                font-size: 12px;
                padding: 6px 10px;
            }
            
            .CodeMirror {
                font-size: 13px;
            }
            
            .statusbar {
                font-size: 10px;
                gap: 8px;
            }
            
            .statusbar-left, .statusbar-right {
                gap: 8px;
            }
        }

        /* Responsivo para smartphones */
        @media (max-width: 480px) {
            :root {
                --toolbar-height: auto;
                --header-height: 45px;
                --statusbar-height: 25px;
            }
            
            .header {
                padding: 6px 10px;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .title {
                font-size: 0.9rem;
                flex: 1;
            }
            
            .toolbar {
                flex-direction: column;
                align-items: stretch;
                padding: 8px;
                gap: 8px;
            }
            
            .toolbar-group {
                justify-content: space-between;
                width: 100%;
                flex-wrap: wrap;
                gap: 4px;
            }
            
            .toolbar-group:first-child {
                order: 1;
            }
            
            .search-container {
                order: 3;
                flex-direction: row;
                gap: 8px;
            }
            
            .toolbar-group:last-child {
                order: 3;
                justify-content: center;
            }
            
            .separator {
                display: none;
            }
            
            select {
                flex: 1;
                min-width: 0;
                font-size: 14px;
            }
            
            input[type="text"] {
                flex: 2;
                min-width: 0;
                font-size: 14px;
            }
            
            button {
                flex: 1;
                font-size: 12px;
                padding: 8px 6px;
                min-height: 40px;
            }
            
            button.icon-btn {
                flex: 0 0 40px;
                width: 40px;
                height: 40px;
            }
            
            .search-results {
                order: 1;
                text-align: center;
                margin: 0;
            }
            
            .nav-buttons {
                order: 2;
                flex: 1;
                justify-content: space-around;
            }
            
            .search-container > button:not(.icon-btn) {
                order: 3;
            }
            
            .CodeMirror {
                font-size: 12px;
                line-height: 1.3;
            }
            
            .statusbar {
                flex-direction: column;
                gap: 2px;
                padding: 3px 8px;
                font-size: 9px;
            }
            
            .statusbar-left, .statusbar-right {
                justify-content: space-between;
                gap: 5px;
                flex-wrap: wrap;
            }
            
            .modal-content {
                padding: 15px;
                margin: 10px;
            }
            
            .settings-row {
                flex-direction: column;
                align-items: stretch;
                gap: 5px;
            }
            
            .settings-label {
                text-align: left;
            }
            
            /* Otimizações para touch */
            .CodeMirror-cursor {
                border-left: 2px solid #000;
            }
            
            .CodeMirror-selected {
                background: rgba(74, 175, 79, 0.2);
            }
        }

        /* Muito pequeno (smartphones em portrait) */
        @media (max-width: 360px) {
            .header {
                padding: 4px 8px;
            }
            
            .title {
                font-size: 0.8rem;
            }
            
            .toolbar {
                padding: 6px;
            }
            
            .CodeMirror {
                font-size: 11px;
            }
            
            button {
                font-size: 11px;
                padding: 6px 4px;
            }
            
            .statusbar {
                font-size: 8px;
            }
        }

        /* Landscape em smartphones */
        @media (max-width: 768px) and (orientation: landscape) {
            .toolbar {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: space-between;
            }
            
            .toolbar-group {
                width: auto;
                flex: 0 1 auto;
            }
            
            .search-container {
                flex-direction: row;
                flex-wrap: wrap;
            }
        }

        /* Melhorias para acessibilidade touch */
        @media (pointer: coarse) {
            button, input, select {
                min-height: 32px;
            }
            
            .icon-btn {
                min-width: 44px;
                min-height: 44px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="title">Editor de Código</h1>
        <div>
            <button id="save-btn">Salvar</button>
        </div>
    </div>

    <div class="toolbar">
        <div class="toolbar-group">
            <select id="language-select">
                <option value="javascript">JavaScript</option>
                <option value="htmlmixed">HTML</option>
                <option value="css">CSS</option>
                <option value="php">PHP</option>
                <option value="python">Python</option>
                <option value="clike">C/C++/Java</option>
                <option value="xml">XML</option>
                <option value="sql">SQL</option>
            </select>
            
            <select id="theme-select">
                <option value="default">Tema Claro</option>
                <option value="monokai">Monokai</option>
                <option value="dracula">Dracula</option>
                <option value="material">Material</option>
                <option value="nord">Nord</option>
                <option value="solarized">Solarized</option>
            </select>
        </div>

        <div class="separator"></div>

        <div class="toolbar-group">
            <button class="icon-btn" id="undo-btn" title="Desfazer (Ctrl+Z)">↩️</button>
            <button class="icon-btn" id="redo-btn" title="Refazer (Ctrl+Y)">↪️</button>
            <button class="icon-btn" id="format-btn" title="Formatar código">🔄</button>
        </div>

        <div class="separator"></div>

        <div class="toolbar-group search-container">
            <input type="text" id="search-input" placeholder="Buscar..." />
            <input type="text" id="replace-input" placeholder="Substituir..." />
            <button id="search-btn" title="Buscar (Ctrl+F)">🔍</button>
            <div class="search-results">
                <span id="search-count">0/0</span>
            </div>
            <div class="nav-buttons">
                <button class="icon-btn" id="prev-btn" title="Anterior (Shift+F3)">▲</button>
                <button class="icon-btn" id="next-btn" title="Próximo (F3)">▼</button>
            </div>
            <button id="replace-btn">Substituir</button>
            <button id="replace-all-btn">Subst. todos</button>
        </div>

        <div class="separator"></div>

        <div class="toolbar-group">
            <button id="snippets-btn">Snippets</button>
            <button id="settings-btn">⚙️</button>
        </div>
    </div>

    <div class="editor-container">
        <textarea id="code-editor"></textarea>
    </div>

    <div class="statusbar">
        <div class="statusbar-left">
            <span id="cursor-position">Ln: 1, Col: 1</span>
            <span id="selection-info"></span>
        </div>
        <div class="statusbar-right">
            <span id="char-count">0 caracteres</span>
            <span id="line-count">0 linhas</span>
            <span id="indentation">Espaços: 4</span>
        </div>
    </div>

    <div id="snippet-container" class="snippet-container">
        <!-- Snippets serão inseridos aqui -->
    </div>

    <div id="settings-modal" class="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Configurações do Editor</h2>
                <button class="modal-close" id="close-settings">&times;</button>
            </div>
            
            <div class="settings-group">
                <h3>Editor</h3>
                <div class="settings-row">
                    <div class="settings-label">Tamanho da fonte</div>
                    <select id="font-size">
                        <option value="12px">12px</option>
                        <option value="14px" selected>14px</option>
                        <option value="16px">16px</option>
                        <option value="18px">18px</option>
                        <option value="20px">20px</option>
                    </select>
                </div>
                <div class="settings-row">
                    <div class="settings-label">Largura da indentação</div>
                    <select id="tab-size">
                        <option value="2">2 espaços</option>
                        <option value="4" selected>4 espaços</option>
                        <option value="8">8 espaços</option>
                    </select>
                </div>
                <div class="settings-row">
                    <div class="settings-label">Usar tabs em vez de espaços</div>
                    <input type="checkbox" id="use-tabs">
                </div>
                <div class="settings-row">
                    <div class="settings-label">Auto-completar parênteses</div>
                    <input type="checkbox" id="auto-close-brackets" checked>
                </div>
                <div class="settings-row">
    <div class="settings-label">Quebra de linha automática</div>
    <input type="checkbox" id="line-wrapping" checked>
</div>
                <div class="settings-row">
                    <div class="settings-label">Numerar linhas</div>
                    <input type="checkbox" id="line-numbers" checked>
                </div>
                <div class="settings-row">
                    <div class="settings-label">Destacar linha atual</div>
                    <input type="checkbox" id="highlight-active-line" checked>
                </div>
            </div>
            
            <div class="settings-group">
                <h3>Auto-salvar</h3>
                <div class="settings-row">
                    <div class="settings-label">Ativar auto-salvar</div>
                    <input type="checkbox" id="auto-save" checked>
                </div>
                <div class="settings-row">
                    <div class="settings-label">Intervalo (segundos)</div>
                    <input type="number" id="auto-save-interval" min="5" max="300" value="30">
                </div>
            </div>
            
            <div style="text-align: right; margin-top: 20px;">
                <button id="reset-settings">Restaurar padrões</button>
                <button id="save-settings">Salvar configurações</button>
            </div>
        </div>
    </div>

    <!-- CodeMirror e addons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    
    <!-- Modos de linguagem -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/clike/clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/php/php.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/sql/sql.min.js"></script>
    
    <!-- Temas adicionais -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/material.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/nord.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/solarized.min.js"></script>
    
    <!-- Addons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/search.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/searchcursor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/dialog/dialog.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/matchesonscrollbar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/scroll/annotatescrollbar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/selection/active-line.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closetag.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/comment/comment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/javascript-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/html-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/css-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/xml-hint.min.js"></script>
    
    <!-- Beautify para formatação de código -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.9/beautify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.9/beautify-html.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.9/beautify-css.min.js"></script>

    <script>
        
        class EnhancedCodeEditor {
            constructor() {
                this.editor = null;
                this.settings = this.loadSettings();
                this.snippets = this.loadSnippets();
                this.searchResults = [];
                this.currentSearchIndex = -1;
                this.autoSaveTimer = null;
                this.lastSavedContent = '';
                
                this.initEditor();
                this.setupEventListeners();
                this.loadEditorContent();
                this.startAutoSave();
                this.updateEditorStats();
            }
            
            initEditor() {
                const textarea = document.getElementById('code-editor');
                
                this.editor = CodeMirror.fromTextArea(textarea, {
                    mode: this.settings.language,
                    theme: this.settings.theme,
                    lineNumbers: this.settings.lineNumbers,
                    indentUnit: parseInt(this.settings.tabSize),
                    tabSize: parseInt(this.settings.tabSize),
                    indentWithTabs: this.settings.useTabs,
                    smartIndent: true,
                    lineWrapping: false,
                    matchBrackets: true,
                    autoCloseBrackets: this.settings.autoCloseBrackets,
                    autoCloseTags: true,
                    styleActiveLine: this.settings.highlightActiveLine,
                    extraKeys: {
                        "Ctrl-Space": "autocomplete",
                        "Ctrl-/": "toggleComment",
                        "Ctrl-S": () => this.saveContent(),
                        "Tab": (cm) => {
                            if (cm.somethingSelected()) {
                                cm.indentSelection("add");
                            } else {
                                if (this.settings.useTabs) {
                                    cm.replaceSelection("\t");
                                } else {
                                    cm.replaceSelection(" ".repeat(cm.getOption("indentUnit")));
                                }
                            }
                        }
                    }
                });
                
                // Aplicar configurações de estilo
                this.updateEditorStyle();
                
                // Outros métodos init...
                this.editor.on('change', () => {
                    this.updateEditorStats();
                });
                
                this.editor.on('cursorActivity', () => {
                    this.updateCursorPosition();
                });
            }
            
            setupEventListeners() {
                // Botões da barra de ferramentas
                document.getElementById('save-btn').addEventListener('click', () => this.saveContent());
                document.getElementById('undo-btn').addEventListener('click', () => this.editor.undo());
                document.getElementById('redo-btn').addEventListener('click', () => this.editor.redo());
                document.getElementById('format-btn').addEventListener('click', () => this.formatCode());
                
                // Busca e substituição
                document.getElementById('search-btn').addEventListener('click', () => this.search());
                document.getElementById('prev-btn').addEventListener('click', () => this.navigateSearch(-1));
                document.getElementById('next-btn').addEventListener('click', () => this.navigateSearch(1));
                document.getElementById('replace-btn').addEventListener('click', () => this.replace());
                document.getElementById('replace-all-btn').addEventListener('click', () => this.replaceAll());
                
                document.getElementById('search-input').addEventListener('input', () => this.search());
                document.getElementById('search-input').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.navigateSearch(1);
                    }
                });
                
                // Seletores de linguagem e tema
                document.getElementById('language-select').addEventListener('change', (e) => {
                    this.changeLanguage(e.target.value);
                });
                
                document.getElementById('theme-select').addEventListener('change', (e) => {
                    this.changeTheme(e.target.value);
                });
                
                // Snippets
                document.getElementById('snippets-btn').addEventListener('click', () => this.toggleSnippetsPanel());
                
                // Configurações
                document.getElementById('settings-btn').addEventListener('click', () => this.openSettings());
                document.getElementById('close-settings').addEventListener('click', () => this.closeSettings());
                document.getElementById('save-settings').addEventListener('click', () => this.saveSettings());
                document.getElementById('reset-settings').addEventListener('click', () => this.resetSettings());
                
                // Inicializar valores dos selects
                document.getElementById('language-select').value = this.settings.language;
                document.getElementById('theme-select').value = this.settings.theme;
                
                // Atalhos de teclado
                document.addEventListener('keydown', (e) => {
                    // Ctrl+F para busca
                    if (e.ctrlKey && e.key === 'f') {
                        e.preventDefault();
                        document.getElementById('search-input').focus();
                    }
                    
                    // F3 para próxima ocorrência
                    if (e.key === 'F3') {
                        e.preventDefault();
                        this.navigateSearch(e.shiftKey ? -1 : 1);
                    }
                });
            }
            
            // Métodos de busca
            search() {
                const query = document.getElementById('search-input').value;
                if (!query) {
                    this.searchResults = [];
                    this.currentSearchIndex = -1;
                    this.updateSearchCount();
                    return;
                }
                
                // Usar o cursor de busca do CodeMirror
                this.searchResults = [];
                this.currentSearchIndex = -1;
                
                const cursor = this.editor.getSearchCursor(query, null, { caseFold: true });
                while (cursor.findNext()) {
                    this.searchResults.push({
                        from: cursor.from(),
                        to: cursor.to()
                    });
                }
                
                if (this.searchResults.length > 0) {
                    this.currentSearchIndex = 0;
                    this.highlightCurrentMatch();
                }
                
                this.updateSearchCount();
            }
            
            navigateSearch(direction) {
                if (this.searchResults.length === 0) return;
                
                this.currentSearchIndex += direction;
                
                // Navegação circular
                if (this.currentSearchIndex < 0) {
                    this.currentSearchIndex = this.searchResults.length - 1;
                } else if (this.currentSearchIndex >= this.searchResults.length) {
                    this.currentSearchIndex = 0;
                }
                
                this.highlightCurrentMatch();
                this.updateSearchCount();
            }
            
            highlightCurrentMatch() {
                if (this.currentSearchIndex === -1 || !this.searchResults.length) return;
                
                const match = this.searchResults[this.currentSearchIndex];
                this.editor.setSelection(match.from, match.to);
                this.editor.scrollIntoView({
                    from: match.from,
                    to: match.to
                }, 50);
            }
            
            updateSearchCount() {
                const countElement = document.getElementById('search-count');
                if (this.searchResults.length === 0) {
                    countElement.textContent = '0/0';
                } else {
                    countElement.textContent = `${this.currentSearchIndex + 1}/${this.searchResults.length}`;
                }
            }
            
            replace() {
                if (this.currentSearchIndex === -1 || !this.searchResults.length) return;
                
                const replaceValue = document.getElementById('replace-input').value;
                const match = this.searchResults[this.currentSearchIndex];
                
                // Faz a substituição
                this.editor.replaceRange(replaceValue, match.from, match.to);
                
                // Atualiza os resultados de busca após a substituição
                this.search();
            }
            
            replaceAll() {
                const searchValue = document.getElementById('search-input').value;
                const replaceValue = document.getElementById('replace-input').value;
                
                if (!searchValue) return;
                
                // Substituir todas as ocorrências
                const text = this.editor.getValue();
                const newText = text.replaceAll(new RegExp(this.escapeRegExp(searchValue), 'gi'), replaceValue);
                this.editor.setValue(newText);
                
                // Atualiza a busca
                this.search();
                
                // Mostra feedback
                alert(`Todas as ocorrências foram substituídas.`);
            }
            
            escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }
            
            // Outras funções
            formatCode() {
                const code = this.editor.getValue();
                const mode = this.editor.getOption('mode');
                let formattedCode = code;
                
                const options = {
                    indent_size: parseInt(this.settings.tabSize),
                    indent_char: this.settings.useTabs ? '\t' : ' ',
                    wrap_line_length: 0,
                    preserve_newlines: true,
                    max_preserve_newlines: 2,
                    end_with_newline: true
                };
                
                if (mode === 'javascript' || mode === 'application/json') {
                    formattedCode = js_beautify(code, options);
                } else if (mode === 'htmlmixed' || mode === 'xml') {
                    formattedCode = html_beautify(code, options);
                } else if (mode === 'css') {
                    formattedCode = css_beautify(code, options);
                }
                
                this.editor.setValue(formattedCode);
                this.editor.setCursor(0, 0);
            }
            
            changeLanguage(language) {
                this.editor.setOption('mode', language);
                this.settings.language = language;
                this.saveSettings();
            }
            
            changeTheme(theme) {
                this.editor.setOption('theme', theme);
                this.settings.theme = theme;
                this.saveSettings();
            }
            
            // Atualização da interface
            updateEditorStats() {
                const content = this.editor.getValue();
                const charCount = content.length;
                const lineCount = this.editor.lineCount();
                
                document.getElementById('char-count').textContent = `${charCount} caracteres`;
                document.getElementById('line-count').textContent = `${lineCount} linhas`;
            }
            
            updateCursorPosition() {
                const cursor = this.editor.getCursor();
                const selection = this.editor.getSelection();
                
                document.getElementById('cursor-position').textContent = `Ln: ${cursor.line + 1}, Col: ${cursor.ch + 1}`;
                
                if (selection && selection.length > 0) {
                    document.getElementById('selection-info').textContent = `Seleção: ${selection.length} caracteres`;
                } else {
                    document.getElementById('selection-info').textContent = '';
                }
            }
            
            updateEditorStyle() {
                const cmElement = this.editor.getWrapperElement();
                cmElement.style.fontSize = this.settings.fontSize;
            }
            
            // Gerenciamento de configurações
            loadSettings() {
                const defaultSettings = {
                    language: 'javascript',
                    theme: 'default',
                    fontSize: '14px',
                    tabSize: '4',
                    useTabs: false,
                    autoCloseBrackets: true,
                    lineWrapping: true,
                    lineNumbers: true,
                    highlightActiveLine: true,
                    autoSave: true,
                    autoSaveInterval: 30
                };
                
                try {
                    const saved = localStorage.getItem('codeEditorSettings');
                    return saved ? JSON.parse(saved) : defaultSettings;
                } catch (e) {
                    console.error('Erro ao carregar configurações:', e);
                    return defaultSettings;
                }
            }
            
            saveSettings() {
                // Coletar configurações do modal
                this.settings.fontSize = document.getElementById('font-size').value;
                this.settings.tabSize = document.getElementById('tab-size').value;
                this.settings.useTabs = document.getElementById('use-tabs').checked;
                this.settings.autoCloseBrackets = document.getElementById('auto-close-brackets').checked;
                this.settings.lineWrapping = document.getElementById('line-wrapping').checked;
                this.settings.lineNumbers = document.getElementById('line-numbers').checked;
                this.settings.highlightActiveLine = document.getElementById('highlight-active-line').checked;
                this.settings.autoSave = document.getElementById('auto-save').checked;
                this.settings.autoSaveInterval = document.getElementById('auto-save-interval').value;
                
                // Aplicar configurações ao editor
                this.editor.setOption('indentUnit', parseInt(this.settings.tabSize));
                this.editor.setOption('tabSize', parseInt(this.settings.tabSize));
                this.editor.setOption('indentWithTabs', this.settings.useTabs);
                this.editor.setOption('autoCloseBrackets', this.settings.autoCloseBrackets);
                this.editor.setOption('lineWrapping', this.settings.lineWrapping);
                this.editor.setOption('lineNumbers', this.settings.lineNumbers);
                this.editor.setOption('styleActiveLine', this.settings.highlightActiveLine);
                
                // Atualizar status bar
                document.getElementById('indentation').textContent = this.settings.useTabs ? 
                    'Indentação: Tabs' : `Espaços: ${this.settings.tabSize}`;
                
                // Atualizar estilo
                this.updateEditorStyle();
                
                // Salvar no localStorage
                try {
                    localStorage.setItem('codeEditorSettings', JSON.stringify(this.settings));
                } catch (e) {
                    console.error('Erro ao salvar configurações:', e);
                }
                
                // Reiniciar autosave se necessário
                this.stopAutoSave();
                if (this.settings.autoSave) {
                    this.startAutoSave();
                }
                
                this.closeSettings();
            }
            
            resetSettings() {
                if (confirm('Deseja restaurar todas as configurações para os valores padrão?')) {
                    localStorage.removeItem('codeEditorSettings');
                    this.settings = this.loadSettings();
                    this.populateSettingsModal();
                    this.saveSettings();
                }
            }
            
            openSettings() {
                this.populateSettingsModal();
                document.getElementById('settings-modal').style.display = 'flex';
            }
            
            closeSettings() {
                document.getElementById('settings-modal').style.display = 'none';
            }
            
            populateSettingsModal() {
                document.getElementById('font-size').value = this.settings.fontSize;
                document.getElementById('tab-size').value = this.settings.tabSize;
                document.getElementById('use-tabs').checked = this.settings.useTabs;
                document.getElementById('auto-close-brackets').checked = this.settings.autoCloseBrackets;
                document.getElementById('line-wrapping').checked = this.settings.lineWrapping;
                document.getElementById('line-numbers').checked = this.settings.lineNumbers;
                document.getElementById('highlight-active-line').checked = this.settings.highlightActiveLine;
                document.getElementById('auto-save').checked = this.settings.autoSave;
                document.getElementById('auto-save-interval').value = this.settings.autoSaveInterval;
            }
            
            // Gerenciamento de snippets
            loadSnippets() {
                const defaultSnippets = [
                    {
                        name: 'Console Log',
                        language: 'javascript',
                        code: 'console.log("${1:mensagem}");'
                    },
                    {
                        name: 'Função JavaScript',
                        language: 'javascript',
                        code: 'function ${1:nomeFuncao}(${2:parametros}) {\n\t${3:// código}\n}'
                    },
                    {
                        name: 'HTML Boilerplate',
                        language: 'htmlmixed',
                        code: '<!DOCTYPE html>\n<html lang="pt-BR">\n<head>\n\t<meta charset="UTF-8">\n\t<meta name="viewport" content="width=device-width, initial-scale=1.0">\n\t<title>${1:Título}</title>\n</head>\n<body>\n\t${2}\n</body>\n</html>'
                    },
                    {
                        name: 'CSS Reset',
                        language: 'css',
                        code: '* {\n\tmargin: 0;\n\tpadding: 0;\n\tbox-sizing: border-box;\n}'
                    },
                    {
                        name: 'PHP Classe',
                        language: 'php',
                        code: '<?php\n\nclass ${1:NomeClasse} {\n\tprivate $${2:propriedade};\n\n\tpublic function __construct(${3:$parametro}) {\n\t\t$this->${2:propriedade} = ${3:$parametro};\n\t}\n\n\tpublic function ${4:metodo}() {\n\t\t${5:// código}\n\t}\n}'
                    },
                    {
                        name: 'Python Função',
                        language: 'python',
                        code: 'def ${1:nome_funcao}(${2:parametros}):\n\t"""${3:Docstring}"""\n\t${4:pass}'
                    }
                ];
                
                try {
                    const saved = localStorage.getItem('codeEditorSnippets');
                    return saved ? JSON.parse(saved) : defaultSnippets;
                } catch (e) {
                    console.error('Erro ao carregar snippets:', e);
                    return defaultSnippets;
                }
            }
            
            saveSnippets() {
                try {
                    localStorage.setItem('codeEditorSnippets', JSON.stringify(this.snippets));
                } catch (e) {
                    console.error('Erro ao salvar snippets:', e);
                }
            }
            
            toggleSnippetsPanel() {
                const panel = document.getElementById('snippet-container');
                
                if (panel.style.display === 'block') {
                    panel.style.display = 'none';
                } else {
                    // Posicionar o painel
                    const button = document.getElementById('snippets-btn');
                    const rect = button.getBoundingClientRect();
                    panel.style.top = `${rect.bottom + 5}px`;
                    panel.style.left = `${rect.left}px`;
                    
                    // Mostrar snippets relevantes para a linguagem atual
                    this.showRelevantSnippets();
                    panel.style.display = 'block';
                }
            }
            
            showRelevantSnippets() {
                const currentMode = this.editor.getOption('mode');
                const container = document.getElementById('snippet-container');
                container.innerHTML = '';
                
                // Filtrar snippets pela linguagem atual ou mostrar todos
                const snippetsToShow = this.snippets.filter(snippet => 
                    snippet.language === currentMode || currentMode === 'all'
                );
                
                if (snippetsToShow.length === 0) {
                    container.innerHTML = '<div class="snippet-item">Nenhum snippet disponível para esta linguagem</div>';
                    return;
                }
                
                snippetsToShow.forEach((snippet, index) => {
                    const snippetElement = document.createElement('div');
                    snippetElement.className = 'snippet-item';
                    snippetElement.innerHTML = `
                        <div class="snippet-name">${snippet.name}</div>
                        <div class="snippet-preview">${this.snippetPreview(snippet.code)}</div>
                    `;
                    snippetElement.addEventListener('click', () => {
                        this.insertSnippet(snippet.code);
                        this.toggleSnippetsPanel();
                    });
                    
                    container.appendChild(snippetElement);
                });
            }
            
            snippetPreview(code) {
                // Limitar previews longos
                return code.length > 100 ? code.substring(0, 100) + '...' : code;
            }
            
            insertSnippet(code) {
                // Implementação básica (sem placeholders de momento)
                const cursor = this.editor.getCursor();
                this.editor.replaceRange(code, cursor);
            }
            
            // Gerenciamento de salvamento
            saveContent() {
                const content = this.editor.getValue();
                
                try {
                    localStorage.setItem('codeEditorContent', content);
                    this.lastSavedContent = content;
                    
                    // Feedback visual
                    const saveBtn = document.getElementById('save-btn');
                    const originalText = saveBtn.textContent;
                    saveBtn.textContent = 'Salvo ✓';
                    setTimeout(() => {
                        saveBtn.textContent = originalText;
                    }, 1000);
                } catch (e) {
                    console.error('Erro ao salvar conteúdo:', e);
                    alert('Erro ao salvar o conteúdo. O armazenamento local pode estar cheio.');
                }
            }
            
            loadEditorContent() {
                try {
                    const content = localStorage.getItem('codeEditorContent') || '';
                    this.editor.setValue(content);
                    this.lastSavedContent = content;
                } catch (e) {
                    console.error('Erro ao carregar conteúdo:', e);
                }
            }
            
            startAutoSave() {
                if (!this.settings.autoSave) return;
                
                this.autoSaveTimer = setInterval(() => {
                    const content = this.editor.getValue();
                    if (content !== this.lastSavedContent) {
                        this.saveContent();
                    }
                }, this.settings.autoSaveInterval * 1000);
            }
            
            stopAutoSave() {
                if (this.autoSaveTimer) {
                    clearInterval(this.autoSaveTimer);
                    this.autoSaveTimer = null;
                }
            }
        }

        // Inicializar o editor quando o documento estiver pronto
        document.addEventListener('DOMContentLoaded', () => {
            const codeEditor = new EnhancedCodeEditor();
            
            // Adicionar evento de beforeunload para alertar sobre alterações não salvas
            window.addEventListener('beforeunload', (e) => {
                const content = codeEditor.editor.getValue();
                if (content !== codeEditor.lastSavedContent) {
                    const message = 'Você tem alterações não salvas. Deseja realmente sair?';
                    e.returnValue = message;
                    return message;
                }
            });
        });
    </script>
</body>
</html>
